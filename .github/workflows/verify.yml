name: Verify C++ Files

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  prepare-matrix-yosupo:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Find yosupo files
        id: set-matrix
        run: |
          problems=$(grep -r -E '^//@yosupo' --include='*.cpp' ./verify | sed -E 's|^(.*)://@yosupo (.*)$|\2$\1|' | jq -Rsc 'split("\n") | map(select(length > 0))')
          echo "matrix=$problems" >> $GITHUB_OUTPUT

  prepare-matrix-yukicoder:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Find yukicoder files
        id: set-matrix
        run: |
          problems=$(grep -r -E '^//@yukicoder' --include='*.cpp' ./verify | sed -E 's|^(.*)://@yukicoder ([^[:space:]]+).*|\2$\1|' | jq -Rsc 'split("\n") | map(select(length > 0))')
          echo "matrix=$problems" >> $GITHUB_OUTPUT

  yosupo-verify:
    needs: prepare-matrix-yosupo
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      fail-fast: false
      matrix:
        problem: ${{ fromJson(needs.prepare-matrix-yosupo.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Extract matrix info
        run: |
          echo "PROBLEM=`echo "${{ matrix.problem }}" | cut -d'$' -f1`" >> $GITHUB_ENV
          echo "FILE=`echo "${{ matrix.problem }}" | cut -d'$' -f2-`" >> $GITHUB_ENV
      - name: Echo filename
        run: echo problem:$PROBLEM,file:$FILE,dir:$DIR
      - name: Clone problems
        run: git clone https://github.com/yosupo06/library-checker-problems.git
      - name: Prepare input files
        run: cd library-checker-problems && ulimit -s unlimited && ./generate.py -p $PROBLEM
      - name: Find problem dir
        run: echo DIR=`find . -path "*/$PROBLEM" -type d` >> $GITHUB_ENV
      - name: Compile target
        run: |
          g++ -std=c++20 -O2 -I `dirname $FILE` $FILE
      - name: Execute
        run: |
          mkdir -p ./out
          find "$DIR"/in -type f -print0 | xargs -0 -I {} sh -c 'ulimit -s unlimited && echo "executing {}..." && cat "{}" | ./a.out >> "./out/$(basename "{}" .in)"'
          find "$DIR"/in -type f -print0 | xargs -0 -I {} sh -c 'echo "judging {}..." && $DIR/checker $DIR/in/$(basename "{}") $DIR/out/$(basename "{}" .in).out ./out/$(basename "{}" .in)'

  yukicoder-verify:
    needs: prepare-matrix-yukicoder
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      fail-fast: false
      matrix:
        problem: ${{ fromJson(needs.prepare-matrix-yukicoder.outputs.matrix) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Extract matrix info
        run: |
          PROBLEM=$(echo "${{ matrix.problem }}" | cut -d'$' -f1)
          FILE=$(echo "${{ matrix.problem }}" | cut -d'$' -f2-)
          echo "PROBLEM=$PROBLEM" >> $GITHUB_ENV
          echo "FILE=$FILE" >> $GITHUB_ENV
          echo "URL=https://yukicoder.me/problems/no/$PROBLEM" >> $GITHUB_ENV
      - name: Echo filename
        run: echo problem:$PROBLEM,file:$FILE,url:$URL
      - name: Install online judge tools
        run: |
          python3 -m pip install --break-system-packages --upgrade --user online-judge-tools online-judge-api-client
          echo "$HOME/.local/bin" >> $GITHUB_PATH
      - name: Download yukicoder testcases via oj
        env:
          YUKICODER_TOKEN: ${{ secrets.YUKICODER_TOKEN }}
        run: |
          set -eu
          BASE_DIR="testcases/${PROBLEM}"
          : "${YUKICODER_TOKEN:?YUKICODER_TOKEN is required}"
          rm -rf "$BASE_DIR"
          mkdir -p "$BASE_DIR"
          oj download "$URL" --system --directory "$BASE_DIR" --yukicoder-token "${YUKICODER_TOKEN}"
      - name: Compile target
        run: |
          g++ -std=c++20 -O2 -I `dirname $FILE` $FILE
      - name: Run oj test
        run: |
          set -eu
          BASE_DIR="testcases/${PROBLEM}"
          if [ ! -d "$BASE_DIR" ]; then
            echo "error: testcases not found under $BASE_DIR" >&2
            exit 1
          fi

          TEST_DIR=""
          while IFS= read -r -d '' candidate; do
            if ls "$candidate"/*.in > /dev/null 2>&1 && ls "$candidate"/*.out > /dev/null 2>&1; then
              TEST_DIR="$candidate"
              break
            fi
          done < <(find "$BASE_DIR" -type d -print0 | sort -z)

          if [ -z "$TEST_DIR" ]; then
            echo "error: no matching (.in, .out) testcase pairs under $BASE_DIR" >&2
            exit 1
          fi

          echo "using test directory: $TEST_DIR"
          oj test -c "./a.out" -d "$TEST_DIR" -t 10 --error 1e-6
